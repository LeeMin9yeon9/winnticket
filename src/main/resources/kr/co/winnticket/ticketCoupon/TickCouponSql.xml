<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.winnticket.ticketCoupon.mapper.TicketCouponMapper">

    <!-- 옵션값 기준 그룹 존재 여부 확인 -->
    <select id="findGroupByOptionValueId" resultType="java.util.UUID">
        SELECT id
        FROM ticket_coupon_groups
        WHERE product_option_value_id = #{productOptionValueId}
            LIMIT 1
    </select>

    <!-- 그룹 생성 -->
    <insert id="insertGroup">
        INSERT INTO ticket_coupon_groups
        (
            id,
            product_id,
            product_option_id,
            product_option_value_id,
            group_name,
            valid_from,
            valid_until,
            created_at,
            updated_at
        )
        VALUES
            (
                #{groupId},
                #{productId},
                #{productOptionId},
                #{productOptionValueId},
                #{groupName},
                #{validFrom},
                #{validUntil},
                now(),
                now()
            )
    </insert>

    <!-- 쿠폰 생성 -->
    <insert id="insertCoupon">
        INSERT INTO ticket_coupons
        (
            id,
            group_id,
            coupon_number,
            status,
            valid_from,
            valid_until,
            created_at,
            updated_at
        )
        VALUES
            (
                gen_random_uuid(),
                #{groupId},
                #{couponNumber},
                'ACTIVE',
                #{validFrom},
                #{validUntil},
                now(),
                now()
            )
    </insert>

    <!-- 그룹 목록 조회(+ ACTIVE/USED 카운트) -->
    <select id="selectGroups" resultType="kr.co.winnticket.ticketCoupon.dto.TicketCouponGroupResDto">
        SELECT
            g.id,
            g.product_id AS productId,
            g.product_option_id AS productOptionId,
            g.product_option_value_id AS productOptionValueId,
            g.group_name AS groupName,
            g.valid_from AS validFrom,
            g.valid_until AS validUntil,
            g.created_at AS createdAt,
            g.updated_at AS updatedAt,
            COALESCE(SUM(CASE WHEN c.status = 'ACTIVE' THEN 1 ELSE 0 END), 0) AS activeCount,
            COALESCE(SUM(CASE WHEN c.status = 'USED' THEN 1 ELSE 0 END), 0) AS usedCount
        FROM ticket_coupon_groups g
                 LEFT JOIN ticket_coupons c ON c.group_id = g.id
        GROUP BY
            g.id, g.product_id, g.product_option_id, g.product_option_value_id,
            g.group_name, g.valid_from, g.valid_until, g.created_at, g.updated_at
        ORDER BY g.created_at DESC
    </select>

    <!-- 그룹 단건 조회(+ ACTIVE/USED 카운트) -->
    <select id="selectGroup" resultType="kr.co.winnticket.ticketCoupon.dto.TicketCouponGroupResDto">
        SELECT
            g.id,
            g.product_id AS productId,
            g.product_option_id AS productOptionId,
            g.product_option_value_id AS productOptionValueId,
            g.group_name AS groupName,
            g.valid_from AS validFrom,
            g.valid_until AS validUntil,
            g.created_at AS createdAt,
            g.updated_at AS updatedAt,
            COALESCE(SUM(CASE WHEN c.status = 'ACTIVE' THEN 1 ELSE 0 END), 0) AS activeCount,
            COALESCE(SUM(CASE WHEN c.status = 'USED' THEN 1 ELSE 0 END), 0) AS usedCount
        FROM ticket_coupon_groups g
                 LEFT JOIN ticket_coupons c ON c.group_id = g.id
        WHERE g.id = #{groupId}
        GROUP BY
            g.id, g.product_id, g.product_option_id, g.product_option_value_id,
            g.group_name, g.valid_from, g.valid_until, g.created_at, g.updated_at
    </select>

    <!-- 그룹별 쿠폰 목록 -->
    <select id="selectCouponsByGroup" resultType="kr.co.winnticket.ticketCoupon.dto.TicketCouponListResDto">
        SELECT
            id,
            group_id AS groupId,
            coupon_number AS couponNumber,
            status,
            valid_from AS validFrom,
            valid_until AS validUntil,
            used_at AS usedAt,
            created_at AS createdAt,
            updated_at AS updatedAt
        FROM ticket_coupons
        WHERE group_id = #{groupId}
        ORDER BY created_at DESC
    </select>

    <!-- 쿠폰 단건 조회 -->
    <select id="selectCoupon" resultType="kr.co.winnticket.ticketCoupon.dto.TicketCouponListResDto">
        SELECT
            id,
            group_id AS groupId,
            coupon_number AS couponNumber,
            status,
            valid_from AS validFrom,
            valid_until AS validUntil,
            used_at AS usedAt,
            created_at AS createdAt,
            updated_at AS updatedAt
        FROM ticket_coupons
        WHERE id = #{couponId}
    </select>

    <!-- 쿠폰 수정 -->
    <update id="updateCoupon">
        UPDATE ticket_coupons
        <set>
            <if test="couponNumber != null and couponNumber != ''">
                coupon_number = #{couponNumber},
            </if>
            <if test="status != null and status != ''">
                status = #{status},
            </if>
            <if test="usedAt != null">
                used_at = #{usedAt},
            </if>
            <if test="validFrom != null">
                valid_from = #{validFrom},
            </if>
            <if test="validUntil != null">
                valid_until = #{validUntil},
            </if>
            updated_at = now()
        </set>
        WHERE id = #{couponId}
    </update>

    <!-- 쿠폰 삭제 -->
    <delete id="deleteCoupon">
        DELETE FROM ticket_coupons
        WHERE id = #{couponId}
    </delete>

    <!-- 그룹 수정 -->
    <update id="updateGroup">
        UPDATE ticket_coupon_groups
        <set>
            <if test="groupName != null and groupName != ''">
                group_name = #{groupName},
            </if>
            <if test="validFrom != null">
                valid_from = #{validFrom},
            </if>
            <if test="validUntil != null">
                valid_until = #{validUntil},
            </if>
            updated_at = now()
        </set>
        WHERE id = #{groupId}
    </update>

    <!-- 그룹 삭제 -->
    <delete id="deleteGroup">
        DELETE FROM ticket_coupon_groups
        WHERE id = #{groupId}
    </delete>

    <!-- 쿠폰번호 중복 체크 -->
    <select id="findCouponIdByCouponNumber" resultType="java.util.UUID">
        SELECT id
        FROM ticket_coupons
        WHERE coupon_number = #{couponNumber}
            LIMIT 1
    </select>

    <!-- 사용 가능한 쿠폰 1개 조회 -->
    <select id="findActiveCoupon" resultType="kr.co.winnticket.ticketCoupon.dto.TicketCouponListResDto">
        SELECT *
        FROM ticket_coupons
        WHERE group_id = #{groupId}
          AND status = 'ACTIVE'
        ORDER BY created_at
            LIMIT 1
    FOR UPDATE
    </select>

    <!-- 쿠폰 판매처리 -->
    <update id="markCouponSold">
        UPDATE ticket_coupons
        SET status = 'SOLD',
            updated_at = now()
        WHERE id = #{couponId}
    </update>

    <!--쿠폰 판매상태 확인 (복구용)-->
    <select id="findCouponStatus" resultType="string">
        SELECT status
        FROM ticket_coupons
        WHERE id = #{couponId}
    </select>

    <!--판매티켓쿠폰 미사용 시 복구-->
    <update id="restoreCoupon">
        UPDATE ticket_coupons
        SET status = 'ACTIVE',
            updated_at = now()
        WHERE id = #{couponId}
    </update>




</mapper>