<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.winnticket.menu.admmenu.mapper.AdminMenuMapper">

    <!-- 관리자 메뉴 검색 + 전체 조회 -->
    <select id="findAdminMenus" resultType="kr.co.winnticket.menu.admmenu.dto.AdminMenuListDto">
        SELECT
        id,
        title,
        title_en      AS titleEn,
        icon,
        page,
        display_order AS displayOrder,
        visible,
        created_at    AS createdAt,
        updated_at    AS updatedAt
        FROM admin_menus
        <where>
            <if test="title != null and title != ''">
                AND title ILIKE CONCAT('%', #{title}, '%')
            </if>
            <if test="titleEn != null and titleEn != ''">
                AND title_en ILIKE CONCAT('%', #{titleEn}, '%')
            </if>
            <if test="page != null and page != ''">
                AND page ILIKE CONCAT('%', #{page}, '%')
            </if>
        </where>
        ORDER BY display_order ASC;
    </select>

    <!-- ID로 단건 조회 -->
    <select id="admMenuFindById" resultType="kr.co.winnticket.menu.admmenu.dto.AdminMenuListDto">
        SELECT
            id,
            title,
            title_en      AS titleEn,
            icon,
            page,
            display_order AS displayOrder,
            visible,
            created_at    AS createdAt,
            updated_at    AS updatedAt
        FROM admin_menus
        WHERE id = #{id}::uuid;
    </select>

    <!-- 관리자 메뉴 생성 -->
    <insert id="admMenuInsert" parameterType="kr.co.winnticket.menu.admmenu.dto.AdminMenuCreateDto">
        INSERT INTO admin_menus (
            title,
            title_en,
            icon,
            page,
            display_order,
            visible,
            created_at,
            updated_at
        ) VALUES (
                     #{title},
                     #{titleEn},
                     #{icon},
                     #{page},
                     #{displayOrder},
                     #{visible},
                     CURRENT_TIMESTAMP,
                     CURRENT_TIMESTAMP
                 );
    </insert>

    <!-- 관리자 메뉴 수정 -->
    <update id="admMenuUpdate">
        UPDATE admin_menus
        <set>
            <if test="adminMenuUpdate.title != null">
                title = #{adminMenuUpdate.title},
            </if>

            <if test="adminMenuUpdate.visible != null">
                visible = #{adminMenuUpdate.visible},
            </if>
            updated_at = CURRENT_TIMESTAMP
        </set>
        WHERE id = #{id}::uuid;
    </update>


    <!-- 관리자 메뉴 삭제 -->
    <delete id="admMenuDelete">
        DELETE FROM admin_menus
        WHERE id = #{id}::uuid;
    </delete>

    <!-- 노출 순서 변경 -->
    <update id="admMenuUpdateOrder">
        UPDATE admin_menus
        SET display_order = #{order},
            updated_at = CURRENT_TIMESTAMP
        WHERE id = #{id}::uuid;
    </update>

    <!-- 활성/비활성 변경 -->
    <update id="admMenuUpdateVisible">
        UPDATE admin_menus
        SET visible = #{visible},
            updated_at = CURRENT_TIMESTAMP
        WHERE id = #{id}::uuid;
    </update>

    <!-- 신규 메뉴 생성 시 순서 번호 조회 -->
    <select id="admMenuGetMaxOrder" resultType="int">
        SELECT COALESCE(MAX(display_order), 0)
        FROM admin_menus;
    </select>

    <!-- 페이지 중복 여부 -->
    <select id="admMenuCountByPage" resultType="int">
        SELECT COUNT(*)
        FROM admin_menus
        WHERE page = #{page};
    </select>

    <!-- 메뉴명 중복 여부 -->
    <select id="admMenuCountByTitle" resultType="int">
        SELECT COUNT(*)
        FROM admin_menus
        WHERE title = #{title};
    </select>

    <update id="shiftUp">
        UPDATE admin_menus
        SET display_order = display_order + 1
        WHERE display_order &gt;= #{newOrder}
          AND display_order &lt; #{oldOrder};
    </update>

    <update id="shiftDown">
        UPDATE admin_menus
        SET display_order = display_order - 1
        WHERE display_order &gt; #{oldOrder}
          AND display_order &lt;= #{newOrder};
    </update>


</mapper>
