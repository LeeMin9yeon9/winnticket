<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.winnticket.product.admin.mapper.ProductMapper">

    <!--
    - 상품 목록 Select
    -->
    <select id="selectProductList" resultType="kr.co.winnticket.product.admin.dto.ProductListGetResDto">
        Select
            a.ID,  -- 상품_ID
            a.IMAGE_URL->>0 As IMAGE,  -- 대표사진
            a.CODE,  -- 상품코드
            a.NAME,  -- 상품명
            a.TYPE,  -- 상품타입
            a.CATEGORY_ID,  -- 카테고리_ID
            a.PARTNER_ID,  -- 파트너_ID
            a.PRICE,  -- 정가
            a.DISCOUNT_PRICE,  -- 판매가
            a.SALES_STATUS,  -- 판매상태
            a.STOCK,  -- 재고
            a.VISIBLE  -- 활성화여부
        FROM
            PRODUCTS a
        Where 1 = 1
        <if test="srchWord != null and srchWord != ''">
            <![CDATA[
            And (
                Upper(a.CODE) Like '%' || Upper(#{srchWord}) || '%'
                OR Upper(a.NAME) LiKE '%' || Upper(#{srchWord}) || '%'
            )
            ]]>
        </if>

        <if test="categoryId != null">
            <![CDATA[
            AND a.CATEGORY_ID = #{categoryId}
            ]]>
        </if>

        <if test="salesStatus != null and salesStatus != '' and salesStatus != 'ALL'">
            <![CDATA[
            AND a.SALES_STATUS = #{salesStatus}::sales_status
        ]]>
        </if>
        Order By
            a.CREATED_AT Desc
    </select>

    <!--
     - 상품 상세 Select
     -->
    <select id="selectProductDetail" resultType="kr.co.winnticket.product.admin.dto.ProductDetailGetResDto">
        Select
            a.ID,  -- 상품_ID
            a.NAME,  -- 상품명
            a.CODE,  -- 상품코드
            a.TYPE,  -- 상품타입
            a.CATEGORY_ID,  -- 카테고리_ID
            a.PARTNER_ID,  -- 파트너_ID
            a.PRICE,  -- 정가
            a.DISCOUNT_PRICE,  -- 판매가
            a.STOCK,  -- 재고
            a.SALES_STATUS,  -- 판매상태
            a.DESCRIPTION,  -- 설명
            a.SHIPPING_INFO,  -- 배송정보
            a.WARRANTY_INFO,  -- 보증정보
            a.RETURN_INFO,  -- 반품/교환정보
            a.DETAIL_CONTENT,  -- 상세설명
            a.USAGE_PERIOD,  -- 사용기한
            a.IMAGE_URL -- 이미지
        FROM
            PRODUCTS a
        Where 1 = 1
        And id = #{id}
    </select>

    <!--
     - 상품 섹션 Select
     -->
    <select id="selectSections" resultType="kr.co.winnticket.product.admin.dto.ProductSectionGetResDto">
        Select
            a.ID,  -- 섹션_ID
            a.NAME,  -- 섹션명
            a.DESCRIPTION,  -- 설명
            COALESCE(b.VISIBLE, false) VISIBLE  -- 노출여부
        From
            SECTION a
        Left Join
            PRODUCT_SECTION b
        On a.ID = b.SECTION_ID
        And b.PRODUCT_ID = #{id}
    </select>

    <!--
     - 상품 옵션 목록 Select
     -->
    <select id="selectOptions" resultType="kr.co.winnticket.product.admin.dto.ProductOptionGetResDto">
        Select
            a.ID,  -- 옵션_ID
            a.NAME,  -- 옵션명
            a.CODE,  -- 옵션코드
            a.REQUIRED  -- 필수여부
        FROM
            PRODUCT_OPTIONS a
        Where 1 = 1
        And a.PRODUCT_ID = #{id}
    </select>

    <!--
     - 상품 옵션 상세 Select
     -->
    <select id="selectProductOptionDetail" resultType="kr.co.winnticket.product.admin.dto.ProductOptionGetResDto">
        Select
            a.ID,  -- 옵션_ID
            a.NAME,  -- 옵션명
            a.CODE,  -- 옵션코드
            a.REQUIRED  -- 필수여부
        FROM
            PRODUCT_OPTIONS a
        Where 1 = 1
          And a.ID = #{id}
    </select>

    <!--
     - 상품 옵션별 가격 Select
     -->
    <select id="selectOptionValues" resultType="kr.co.winnticket.product.admin.dto.ProductOptionValueGetResDto">
        Select
            a.ID,  -- 옵션별가격_ID
            a.CODE,  -- 코드
            a.VALUE,  -- 옵션별가격명
            a.ADDITIONAL_PRICE  -- 추가가격
        FROM
            PRODUCT_OPTION_VALUES a
        Where 1 = 1
        And a.OPTION_ID = #{id}
    </select>

    <!--
    - 상품 insert
    -->
    <insert id="insertProduct" parameterType="kr.co.winnticket.product.admin.dto.ProductPostReqDto">
        <![CDATA[
        Insert Into PRODUCTS
        (
            NAME,
            CODE,
            TYPE,
            CATEGORY_ID,
            PARTNER_ID,
            DESCRIPTION,
            IMAGE_URL,
            PRICE,
            DISCOUNT_PRICE,
            SALES_STATUS,
            STOCK,
            SALES_START_DATE,
            SALES_END_DATE,
            DISPLAY_ORDER,
            VISIBLE
        )
        Values
        (
            #{name},
            'PRD' || nextval('product_code_seq'),
            #{type}::product_type,
            #{categoryId},
            #{partnerId},
            #{description},
            #{imageUrl, jdbcType=OTHER, typeHandler=kr.co.winnticket.common.typehandler.JsonListTypeHandler},
            #{price},
            #{discountPrice},
            #{salesStatus}::sales_status,
            #{stock},
            #{salesStartDate},
            #{salesEndDate},
            COALESCE((SELECT MAX(display_order) + 1 FROM PRODUCTS), 1),
            #{visible}
        )
        ]]>
    </insert>

    <!--
    - 상품 기본정보 수정
    -->
    <update id="updateProductBasic">
        Update PRODUCTS
        <set>
            <if test="model.name != null and model.name != ''">
                NAME = #{model.name},
            </if>
            <if test="model.categoryId != null">
                CATEGORY_ID = #{model.categoryId},
            </if>
            <if test="model.partnerId != null">
                PARTNER_ID = #{model.partnerId},
            </if>
            <if test="model.price != null">
                PRICE = #{model.price},
            </if>
            <if test="model.discountPrice != null">
                DISCOUNT_PRICE = #{model.discountPrice},
            </if>
            <if test="model.stock != null">
                STOCK = #{model.stock},
            </if>
            <if test="model.salesStatus != null">
                SALES_STATUS = #{model.salesStatus}::sales_status,
            </if>
            <if test="model.description != null">
                DESCRIPTION = #{model.description},
            </if>
            <if test="model.visible != null">
                VISIBLE = #{model.visible},
            </if>
            <if test="model.imageUrl != null">
                IMAGE_URL = #{model.imageUrl, jdbcType=OTHER, typeHandler=kr.co.winnticket.common.typehandler.JsonListTypeHandler},
            </if>
            UPDATED_AT = CURRENT_TIMESTAMP
        </set>
        Where 1 = 1
        And ID = #{id}
    </update>

    <!--
    - 상품 배송정보 수정
    -->
    <update id="updateProductShipping">
        Update PRODUCTS
        <set>
            <if test="model.shippingInfo != null and model.shippingInfo != ''">
                SHIPPING_INFO = #{model.shippingInfo},
            </if>
            <if test="model.warrantyInfo != null and model.warrantyInfo != ''">
                WARRANTY_INFO = #{model.warrantyInfo},
            </if>
            <if test="model.returnInfo != null and model.returnInfo != ''">
                RETURN_INFO = #{model.returnInfo},
            </if>
            <if test="model.usagePeriod != null and model.usagePeriod != ''">
                USAGE_PERIOD = #{model.usagePeriod},
            </if>
            UPDATED_AT = CURRENT_TIMESTAMP
        </set>
        Where 1 = 1
        And ID = #{id}
    </update>

    <!--
    - 상품 섹션정보 수정
    -->
    <update id="updateProductSection">
        <choose>
            <when test="visible == true">
                INSERT INTO PRODUCT_SECTION
                (
                    PRODUCT_ID,
                    SECTION_ID,
                    VISIBLE
                )
                VALUES
                (
                    #{id},
                    #{sectionId},
                    TRUE
                )
                ON CONFLICT (PRODUCT_ID, SECTION_ID)
                DO UPDATE SET visible = TRUE,
                updated_at = NOW();
            </when>
            <otherwise>
                DELETE FROM PRODUCT_SECTION
                WHERE PRODUCT_ID = #{id}
                AND SECTION_ID = #{sectionId};
            </otherwise>
        </choose>
    </update>

    <!--
    - 상품 상세내용 수정
    -->
    <update id="updateProductDetailContent">
        Update PRODUCTS
        <set>
            <if test="detailContent != null and detailContent != ''">
                DETAIL_CONTENT = #{detailContent},
            </if>
            UPDATED_AT = CURRENT_TIMESTAMP
        </set>
        Where 1 = 1
        And ID = #{id}
    </update>

    <!--
    - 상품 삭제
    -->
    <delete id="deleteProduct">
        DELETE FROM PRODUCTS
        WHERE 1 = 1
        And ID = #{id}
    </delete>
        
    <!--
    - 상품 옵션 등록
    -->
    <insert id="insertProductOption" parameterType="map" useGeneratedKeys="true" keyProperty="model.optionId">
        Insert Into PRODUCT_OPTIONS
        (
            PRODUCT_ID,
            NAME,
            CODE,
            REQUIRED
        )
        Values
        (
            #{id},
            #{model.name},
            #{model.code},
            #{model.required}
        )
    </insert>

    <!--
    - 상품별 옵션 수정
    -->
    <update id="updateProductOption">
        Update PRODUCT_OPTIONS
        <set>
            <if test="model.name != null and model.name != ''">
                NAME = #{model.name},
            </if>
            <if test="model.code != null and model.code != ''">
                CODE = #{model.code},
            </if>
            <if test="model.required != null">
                REQUIRED = #{model.required},
            </if>
            UPDATED_AT = CURRENT_TIMESTAMP
        </set>
        Where 1 = 1
        And ID = #{optionId}
    </update>

    <!--
    - 상품 옵션별 가격 등록
    -->
    <insert id="insertOptionValue">
        Insert Into PRODUCT_OPTION_VALUES
        (
            OPTION_ID,
            VALUE,
            CODE,
            ADDITIONAL_PRICE
        )
        Values
        (
            #{optionId},
            #{model.value},
            #{model.code},
            #{model.additionalPrice}
        )
    </insert>

    <!--
    - 상품 옵션별 가격 삭제
    -->
    <delete id="deleteOptionValues">
        DELETE FROM PRODUCT_OPTION_VALUES
        WHERE ID IN
        <foreach item="id" collection="list" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <!--
    - 상품별 옵션별 옵션값 전체삭제
    -->
    <delete id="deleteOptionValuesByOptionId">
        DELETE FROM PRODUCT_OPTION_VALUES
        WHERE 1 = 1
        And OPTION_ID = #{id}
    </delete>

    <!--
    - 상품별 옵션 삭제
    -->
    <delete id="deleteProductOption">
        DELETE FROM PRODUCT_OPTIONS
        WHERE 1 = 1
        And ID = #{id}
    </delete>

    <!--
     - 섹션 목록 Select
     -->
    <select id="selectSectionList" resultType="kr.co.winnticket.product.admin.dto.SectionListGetResDto">
        Select
            a.ID,  -- 섹션_ID
            a.CODE,  -- 코드
            a.NAME,  -- 이름
            a.DISPLAY_ORDER,  -- 표시순서
            a.IS_ACTIVE,  -- 활성화여부
            a.IS_SYSTEM,  -- 시스템등록여부
            a.DESCRIPTION  -- 설명
        FROM
            SECTION a
        Where 1 = 1
        Order By
            a.DISPLAY_ORDER ASC
    </select>

    <!--
     - 활성화 섹션 목록 Select
     -->
    <select id="selectSectionListActive" resultType="kr.co.winnticket.product.admin.dto.SectionListActiveGetResDto">
        Select
            a.ID,  -- 섹션_ID
            a.CODE,  -- 코드
            a.NAME,  -- 이름
            a.DISPLAY_ORDER,  -- 표시순서
            a.IS_ACTIVE,  -- 활성화여부
            a.IS_SYSTEM,  -- 시스템등록여부
            a.DESCRIPTION  -- 설명
        FROM
            SECTION a
        Where 1 = 1
        And IS_ACTIVE = true
        Order By
            a.DISPLAY_ORDER ASC
    </select>

    <!--
     - 섹션 상세 Select
     -->
    <select id="selectSectionDetail" resultType="kr.co.winnticket.product.admin.dto.SectionDetailGetResDto">
        Select
            a.ID,  -- 섹션_ID
            a.CODE,  -- 코드
            a.NAME,  -- 이름
            a.DISPLAY_ORDER,  -- 표시순서
            a.IS_ACTIVE,  -- 활성화여부
            a.IS_SYSTEM,  -- 시스템등록여부
            a.DESCRIPTION  -- 설명
        FROM
            SECTION a
        Where 1 = 1
        And a.ID = #{id}
    </select>

    <!--
     - 섹션 등록
     -->
    <insert id="insertSection">
        Insert Into SECTION
        (
            CODE,
            NAME,
            DISPLAY_ORDER,
            DESCRIPTION,
            IS_ACTIVE,
            IS_SYSTEM
        )
        Values
        (
            #{code},
            #{name},
            #{displayOrder},
            #{description},
            #{isActive},
            false
        )
    </insert>

    <!--
    - 섹션 수정
    -->
    <update id="updateSection">
        Update SECTION
        <set>
            <if test="model.code != null and model.code != ''">
                CODE = #{model.code},
            </if>
            <if test="model.name != null and model.name != ''">
                NAME = #{model.name},
            </if>
            <if test="model.displayOrder != null">
                DISPLAY_ORDER = #{model.displayOrder},
            </if>
            <if test="model.description != null and model.description != ''">
                DESCRIPTION = #{model.description},
            </if>
            <if test="model.isActive != null">
                IS_ACTIVE = #{model.isActive},
            </if>
            UPDATED_AT = CURRENT_TIMESTAMP
        </set>
        Where 1 = 1
        And ID = #{id}
    </update>

    <!--
    - 섹션 삭제
    -->
    <delete id="deleteSection">
        DELETE FROM SECTION
        WHERE 1 = 1
        And ID = #{id}
    </delete>

    <!-- Max Order Select
    -->
    <select id="getMaxDisplayOrder" resultType="int">
        SELECT COALESCE(MAX(display_order), 0) FROM section
    </select>

    <!-- INSERT 시 order 밀기 -->
    <update id="shiftDisplayOrderForInsert">
        <![CDATA[
        UPDATE section
        SET display_order = display_order + 1
        WHERE display_order >= #{newOrder}
        ]]>
    </update>

    <!-- 수정 시: old > new (ex: 5→2 → 2~4 +1) -->
    <update id="shiftDisplayOrderForMoveUp">
        <![CDATA[
        UPDATE section
        SET display_order = display_order + 1
        WHERE display_order >= #{newOrder}
        AND display_order <  #{oldOrder}
        ]]>
    </update>

    <!-- 수정 시: old < new (ex: 2→5 → 3~5 -1) -->
    <update id="shiftDisplayOrderForMoveDown">
        <![CDATA[
        UPDATE section
        SET display_order = display_order - 1
        WHERE display_order <= #{newOrder}
        AND display_order >  #{oldOrder}
        ]]>
    </update>

    <!--
    - 섹션 정렬순서 재정렬
    -->
    <update id="reorderAllDisplayOrders">
        With reordered As (
            Select
                id,
                Row_Number() Over (Order By DISPLAY_ORDER) NEW_ORDER
            From
                SECTION
        )
        Update SECTION a
        Set
            DISPLAY_ORDER = x.NEW_ORDER
            From
            reordered x
        Where 1 = 1
        And a.id = x.id
    </update>
</mapper>
