<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.winnticket.product.shop.mapper.ProductShopMapper">


    <!--
    - 섹션목록 조회
    -->
    <select id="selectSection" resultType="kr.co.winnticket.product.shop.dto.ProductSectionListGetResDto">
        SELECT
            a.ID As SECTION_ID,
            a.CODE As SECTION_CODE,
            a.NAME As SECTION_NAME
        FROM SECTION a
        WHERE 1 = 1
        And a.IS_ACTIVE = true
        And Exists (
            Select 1
            From
                PRODUCT_SECTION x
            Join PRODUCTS y
            On x.PRODUCT_ID = y.ID
            Where 1 = 1
            And x.SECTION_ID = a.ID
            And y.VISIBLE = true
            And y.SALES_STATUS In ('READY', 'ON_SALE')
        )
        ORDER BY
            a.DISPLAY_ORDER;
    </select>

    <!--
    - 섹션별상품 조회
    -->
    <select id="selectSectionProduct" resultType="kr.co.winnticket.product.shop.dto.ProductSectionProductGetResDto">
        Select
            b.CODE,  -- 상품코드
            b.NAME,  -- 상품명
            b.PRICE,  -- 정가
            b.IMAGE_URL->>0 As IMAGE,  -- 대표사진
            b.DISCOUNT_PRICE,  -- 판매가
            FLOOR(( (b.PRICE - b.DISCOUNT_PRICE) / b.PRICE::float ) * 100) As DISCOUNT_RATE,  -- 할인율
            b.SALES_STATUS,  -- 판매상태
            b.USAGE_PERIOD  -- 사용기한
        From
            PRODUCT_SECTION a
        Join
            PRODUCTS b
        On a.PRODUCT_ID = b.ID
        Where 1 = 1
        And a.SECTION_ID = #{sectionId}
        And b.SALES_STATUS IN ('READY', 'ON_SALE')
        And b.VISIBLE = true
        Order By
            b.CREATED_AT desc
    </select>

    <!--
    - 상품 목록 검색
    -->
    <select id="selectProductListSearch" resultType="kr.co.winnticket.product.shop.dto.ProductShopListGetResDto">
        Select
        a.CODE,  -- 상품코드
        a.NAME,  -- 상품명
        a.PRICE,  -- 정가
        a.IMAGE_URL->>0 As IMAGE,  -- 대표사진
        a.DISCOUNT_PRICE,  -- 판매가
        FLOOR(( (a.PRICE - a.DISCOUNT_PRICE) / a.PRICE::float ) * 100) As DISCOUNT_RATE,  -- 할인율
        a.SALES_STATUS,  -- 판매상태
        a.USAGE_PERIOD  -- 사용기한
        FROM
        PRODUCTS a
        Where 1 = 1
        <if test="name != null and name != ''">
            <![CDATA[
            AND UPPER(a.NAME) LIKE '%' || UPPER(#{name}) || '%'
            ]]>
        </if>
        And a.SALES_STATUS IN ('READY', 'ON_SALE')
        And a.VISIBLE = true
        Order By
        a.CREATED_AT Desc
    </select>

    <!--
    - 상품 목록 Select
    -->
    <select id="selectProductList" resultType="kr.co.winnticket.product.shop.dto.ProductShopListGetResDto">
        Select
            a.CODE,  -- 상품코드
            a.NAME,  -- 상품명
            a.PRICE,  -- 정가
            a.IMAGE_URL->>0 As IMAGE,  -- 대표사진
            a.DISCOUNT_PRICE,  -- 판매가
            FLOOR(( (a.PRICE - a.DISCOUNT_PRICE) / a.PRICE::float ) * 100) As DISCOUNT_RATE,  -- 할인율
            a.SALES_STATUS,  -- 판매상태
            a.USAGE_PERIOD  -- 사용기한
        FROM
            PRODUCTS a
        Join MENU_CATEGORIES b
        On a.CATEGORY_ID = b.ID
        Where 1 = 1
        <if test="subCategory != null and subCategory != ''">
            <![CDATA[
            AND b.CODE = #{subCategory}
            ]]>
        </if>

        <if test="(subCategory == null or subCategory == '')
                and (mainCategory != null and mainCategory != '')">
            <![CDATA[
            AND (b.CODE = #{mainCategory}
            Or b.PARENT_ID = (Select ID From MENU_CATEGORIES Where 1 = 1 And CODE = #{mainCategory}))
            ]]>
        </if>
        And a.SALES_STATUS IN ('READY', 'ON_SALE')
        And a.VISIBLE = true
        Order By
        a.CREATED_AT Desc
    </select>

    <!--
    - 상품 상세 조회
    -->
    <select id="selectProductDetail" resultType="kr.co.winnticket.product.shop.dto.ProductShopDetailGetResDto">
        Select
            a.id,  -- 상품id
            a.CODE,  -- 상품코드
            a.TYPE,  -- 타입
            a.IMAGE_URL,  -- 대표사진
            a.NAME,  -- 상품명
            (
                Select
                    x.Name
                From
                    MENU_CATEGORIES x
                Where 1 = 1
                  And x.ID = a.CATEGORY_ID
            ) CATEGORY_NAME,  -- 카테고리명
            a.DESCRIPTION,  -- 상품설
            a.PRICE,  -- 정가
            a.DISCOUNT_PRICE,  -- 판매가
            FLOOR(( (a.PRICE - a.DISCOUNT_PRICE) / a.PRICE::float ) * 100) As DISCOUNT_RATE,  -- 할인율
            a.SHIPPING_INFO,  -- 배송정보
            a.WARRANTY_INFO,  -- 보증정보
            a.RETURN_INFO,  -- 반품/교환정보
            a.DETAIL_CONTENT,  -- 상품상세설명
            a.USAGE_PERIOD  -- 사용기한
        FROM
            PRODUCTS a
        Where 1 = 1
        And a.CODE = #{code}
    </select>

    <!--
    - 상품 날짜별 가격 조회
    -->
    <select id="selectStayDatePrices" resultType="kr.co.winnticket.product.shop.dto.ProductDatePriceGetResDto">
        SELECT
            sd.option_value_id,
            ov.value            AS option_value_name,
            sd.price_date,
        sd.price,
        sd.discount_price,
        sd.is_available
        FROM stay_date_prices sd
            JOIN product_option_values ov
        ON ov.id = sd.option_value_id
            JOIN product_options o
            ON o.id = ov.option_id
            join products p
            on p.id = o.product_id
        WHERE p.CODE = #{code}
        ORDER BY
            sd.option_value_id,
            sd.price_date
    </select>
</mapper>