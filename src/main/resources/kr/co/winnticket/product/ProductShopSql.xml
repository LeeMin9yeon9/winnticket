<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.winnticket.product.shop.mapper.ProductShopMapper">


    <!--
    - 섹션목록 조회
    -->
    <select id="selectSection" resultType="kr.co.winnticket.product.shop.dto.ProductSectionListGetResDto">
        SELECT
            a.ID As SECTION_ID,
            a.CODE As SECTION_CODE,
            a.NAME As SECTION_NAME
        FROM SECTION a
        WHERE 1 = 1
        And a.IS_ACTIVE = true
        And Exists (
            Select 1
            From
                PRODUCT_SECTION x
            Join PRODUCTS y
            On x.PRODUCT_ID = y.ID
            LEFT JOIN channel_products z
            ON z.product_id = y.id
            AND z.channel_id = #{channelId}
            Where 1 = 1
            And x.SECTION_ID = a.ID
            And y.VISIBLE = true
            AND z.product_id IS NULL
        )
        ORDER BY
            a.DISPLAY_ORDER;
    </select>

    <!--
    - 섹션별상품 조회
    -->
    <select id="selectSectionProduct" resultType="kr.co.winnticket.product.shop.dto.ProductSectionProductGetResDto">
        <![CDATA[
        SELECT
            b.CODE,
            b.NAME,
            COALESCE(pcp.base_price, b.PRICE) AS PRICE,
            b.IMAGE_URL->>0 AS IMAGE,
            COALESCE(pcp.discount_price, b.DISCOUNT_PRICE) AS DISCOUNT_PRICE,
            CASE
            WHEN COALESCE(pcp.discount_price, b.DISCOUNT_PRICE) IS NOT NULL
            AND COALESCE(pcp.base_price, b.PRICE) > 0
            THEN FLOOR(
            (
            COALESCE(pcp.base_price, b.PRICE)
            - COALESCE(pcp.discount_price, b.DISCOUNT_PRICE)
            )
            / COALESCE(pcp.base_price, b.PRICE)::float * 100
            )
            ELSE 0
        END AS DISCOUNT_RATE,
            b.SALES_STATUS,
            b.USAGE_PERIOD
        FROM PRODUCT_SECTION a
        JOIN PRODUCTS b
        ON a.PRODUCT_ID = b.ID
        LEFT JOIN product_channel_prices pcp
        ON pcp.product_id = b.id
        AND pcp.channel_id = #{channelId}
        LEFT JOIN channel_products c
        ON c.product_id = b.id
        AND c.channel_id = #{channelId}
        WHERE a.SECTION_ID = #{sectionId}
        AND b.VISIBLE = true
        AND c.product_id IS NULL
        ORDER BY
            CASE
            WHEN b.SALES_STATUS = 'ON_SALE' THEN 1
            WHEN b.SALES_STATUS = 'READY' THEN 2
            END,
            b.CREATED_AT DESC;
        ]]>
    </select>

    <!--
    - 상품 목록 검색
    -->
    <select id="selectProductListSearch" resultType="kr.co.winnticket.product.shop.dto.ProductShopListGetResDto">
        SELECT
            a.CODE,
            a.NAME,
            COALESCE(pcp.base_price, a.PRICE) AS PRICE,
            a.IMAGE_URL->>0 AS IMAGE,
            COALESCE(pcp.discount_price, a.DISCOUNT_PRICE) AS DISCOUNT_PRICE,
            CASE
            WHEN COALESCE(pcp.discount_price, a.DISCOUNT_PRICE) IS NOT NULL
            AND COALESCE(pcp.base_price, a.PRICE) > 0
            THEN FLOOR(
            (
            COALESCE(pcp.base_price, a.PRICE)
            - COALESCE(pcp.discount_price, a.DISCOUNT_PRICE)
            )
            / COALESCE(pcp.base_price, a.PRICE)::float * 100
            )
            ELSE 0
            END AS DISCOUNT_RATE,
            a.SALES_STATUS,
            a.USAGE_PERIOD
        FROM PRODUCTS a
        LEFT JOIN product_channel_prices pcp
        ON pcp.product_id = a.id
        AND pcp.channel_id = #{channelId}
        LEFT JOIN CHANNEL_PRODUCTS cp
        ON cp.PRODUCT_ID = a.ID
        AND cp.CHANNEL_ID = #{channelId}
        WHERE 1 = 1
        <if test="name != null and name != ''">
            <![CDATA[
            AND UPPER(a.NAME) LIKE '%' || UPPER(#{name}) || '%'
            ]]>
        </if>
        AND a.VISIBLE = true
        AND cp.PRODUCT_ID IS NULL
        ORDER BY
        CASE
        WHEN a.SALES_STATUS = 'ON_SALE' THEN 1
        WHEN a.SALES_STATUS = 'READY' THEN 2
        END,
        a.CREATED_AT DESC
    </select>

    <!--
    - 상품 목록 Select
    -->
    <select id="selectProductList" resultType="kr.co.winnticket.product.shop.dto.ProductShopListGetResDto">
        SELECT
            a.CODE,
            a.NAME,
            COALESCE(pcp.base_price, a.PRICE) AS PRICE,
            a.IMAGE_URL->>0 AS IMAGE,
            COALESCE(pcp.discount_price, a.DISCOUNT_PRICE) AS DISCOUNT_PRICE,
            CASE
            WHEN COALESCE(pcp.discount_price, a.DISCOUNT_PRICE) IS NOT NULL
            AND COALESCE(pcp.base_price, a.PRICE) > 0
            THEN FLOOR(
            (
            COALESCE(pcp.base_price, a.PRICE)
            - COALESCE(pcp.discount_price, a.DISCOUNT_PRICE)
            )
            / COALESCE(pcp.base_price, a.PRICE)::float * 100
            )
            ELSE 0
            END AS DISCOUNT_RATE,
            a.SALES_STATUS,
            a.USAGE_PERIOD
        FROM PRODUCTS a
        JOIN MENU_CATEGORIES b
        ON a.CATEGORY_ID = b.ID
        LEFT JOIN product_channel_prices pcp
        ON pcp.product_id = a.id
        AND pcp.channel_id = #{channelId}
        LEFT JOIN CHANNEL_PRODUCTS cp
        ON cp.PRODUCT_ID = a.ID
        AND cp.CHANNEL_ID = #{channelId}
        WHERE 1 = 1
        <if test="subCategory != null and subCategory != ''">
            <![CDATA[
            AND b.CODE = #{subCategory}
            ]]>
        </if>
        <if test="(subCategory == null or subCategory == '')
        and (mainCategory != null and mainCategory != '')">
            <![CDATA[
            AND (
                b.CODE = #{mainCategory}
                OR b.PARENT_ID = (
                    SELECT ID
                    FROM MENU_CATEGORIES
                    WHERE CODE = #{mainCategory}
                )
            )
            ]]>
        </if>
        AND a.VISIBLE = true
        AND cp.PRODUCT_ID IS NULL
        ORDER BY
        CASE
        WHEN a.SALES_STATUS = 'ON_SALE' THEN 1
        WHEN a.SALES_STATUS = 'READY' THEN 2
        END,
        a.CREATED_AT DESC
    </select>

    <!--
    - 상품 상세 조회
    -->
    <select id="selectProductDetail" resultType="kr.co.winnticket.product.shop.dto.ProductShopDetailGetResDto">
        <![CDATA[
        SELECT
            a.id,
            a.CODE,
            a.TYPE,
            a.IMAGE_URL,
            a.NAME,
            (
                SELECT x.NAME
                FROM MENU_CATEGORIES x
                WHERE x.ID = a.CATEGORY_ID
            ) AS CATEGORY_NAME,
            a.DESCRIPTION,
            COALESCE(pcp.base_price, a.PRICE) AS PRICE,
            COALESCE(pcp.discount_price, a.DISCOUNT_PRICE) AS DISCOUNT_PRICE,
            CASE
                WHEN COALESCE(pcp.discount_price, a.DISCOUNT_PRICE) IS NOT NULL
                    AND COALESCE(pcp.base_price, a.PRICE) > 0
                    THEN FLOOR(
                        (
                            COALESCE(pcp.base_price, a.PRICE)
                                - COALESCE(pcp.discount_price, a.DISCOUNT_PRICE)
                            )
                            / COALESCE(pcp.base_price, a.PRICE)::float * 100
                         )
                ELSE 0
                END AS DISCOUNT_RATE,
            a.SALES_STATUS,
            a.SHIPPING_INFO,
            a.WARRANTY_INFO,
            a.RETURN_INFO,
            a.DETAIL_CONTENT,
            a.USAGE_PERIOD
        FROM PRODUCTS a
        LEFT JOIN product_channel_prices pcp
        ON pcp.product_id = a.id
        AND pcp.channel_id = #{channelId}
        WHERE a.CODE = #{code}
        ]]>
    </select>

    <!--
    - 상품 날짜별 가격 조회
    -->
    <select id="selectStayDatePrices" resultType="kr.co.winnticket.product.shop.dto.ProductDatePriceGetResDto">
        SELECT
            sd.option_value_id,
            ov.value            AS option_value_name,
            sd.price_date,
        sd.price,
        sd.discount_price,
        sd.is_available
        FROM stay_date_prices sd
            JOIN product_option_values ov
        ON ov.id = sd.option_value_id
            JOIN product_options o
            ON o.id = ov.option_id
            join products p
            on p.id = o.product_id
        WHERE p.CODE = #{code}
        ORDER BY
            sd.option_value_id,
            sd.price_date
    </select>

    <!--
     - 상품 옵션 목록 Select
     -->
    <select id="selectShopOptions" resultType="kr.co.winnticket.product.shop.dto.ProductShopOptionGetResDto">
        Select
            a.ID,  -- 옵션_ID
            a.NAME,  -- 옵션명
            a.CODE,  -- 옵션코드
            a.PRICE_TYPE AS priceType,  -- 옵션별가격타입
            a.REQUIRED  -- 필수여부
        FROM
            PRODUCT_OPTIONS a
        Where 1 = 1
          And a.PRODUCT_ID = #{productId}
    </select>

    <!-- 옵션별 가격 Select -->
    <select id="selectShopOptionValues"
            resultType="kr.co.winnticket.product.shop.dto.ProductShopOptionValueGetResDto">
        SELECT
            v.ID,
            v.CODE,
            v.VALUE,
            v.STOCK,
            COALESCE(pcov.price, v.ADDITIONAL_PRICE) AS ADDITIONAL_PRICE
        FROM PRODUCT_OPTION_VALUES v
        LEFT JOIN product_channel_option_prices pcov
        ON pcov.option_value_id = v.ID
        AND pcov.channel_id = #{channelId}
        WHERE v.OPTION_ID = #{optionId}
    </select>
</mapper>