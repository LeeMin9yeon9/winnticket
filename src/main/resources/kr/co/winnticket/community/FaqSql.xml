<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.winnticket.community.faq.mapper.FaqMapper">

    <!--
    - FAQ 목록 Select
    -->
    <select id="selectFaqList" resultType="kr.co.winnticket.community.faq.dto.FaqListGetResDto">
        Select
            a.ID,  -- 아이디
            a.TYPE,  -- 타입
            a.TITLE,  -- 제목
            a.AUTHOR_NAME,  -- 작성자
            a.CREATED_AT,  -- 작성일자
            a.VIEWS,  -- 조회수
            a.IS_ACTIVE,  -- 활성화여부
            a.CATEGORY  -- 카테고리
        FROM
            POSTS a
        Where 1 = 1
        And a.TYPE = 'FAQ'
        <if test="title != null and title != ''">
        <![CDATA[
            And Upper(a.TITLE) Like '%' || Upper(#{title}) || '%'
        ]]>
        </if>

        <if test="begDate != null">
        <![CDATA[
            AND Date(a.created_at) >= #{begDate}
        ]]>
        </if>

        <if test="endDate != null">
        <![CDATA[
            AND Date(a.created_at) <= #{endDate}
        ]]>
        </if>
        Order By
            a.CREATED_AT Desc
    </select>

    <!--
    - FAQ 상세 Select
    -->
    <select id="selectFaqDetail" resultType="kr.co.winnticket.community.faq.dto.FaqDetailGetResDto">
        <![CDATA[
        Select
            a.ID,  -- 아이디
            a.TYPE,  -- 타입
            a.TITLE,  -- 제목
            a.AUTHOR_NAME,  -- 작성자
            a.CREATED_AT,  -- 작성일시
            a.VIEWS,  -- 조회수
            a.CONTENT,  -- 내용
            a.CATEGORY  -- 카테고리
        FROM
            POSTS a
        Where 1 = 1
        And TYPE = 'FAQ'
        And a.ID = #{id}
        ]]>
    </select>

    <!--
    - FAQ insert
    -->
    <insert id="insertFaq" parameterType="kr.co.winnticket.community.faq.dto.FaqPostReqDto">
        <![CDATA[
        Insert Into POSTS
        (
            TYPE,
            TITLE,
            CONTENT,
            AUTHOR_NAME,
            VIEWS,
            CATEGORY,
            IS_ACTIVE
        )
        Values
        (
            'FAQ',
            #{title},
            #{content},
            #{authorName},
            0,
            #{category},
            #{isActive}
        )
        ]]>
    </insert>

    <!--
    - FAQ update
    -->
    <update id="updateFaq">
        Update POSTS
        <set>
            <if test="title != null and title != ''">
                TITLE = #{title},
            </if>
            <if test="content != null and content != ''">
                CONTENT = #{content},
            </if>
            <if test="category != null and category != ''">
                CATEGORY = #{category},
            </if>
                UPDATED_AT = CURRENT_TIMESTAMP
        </set>
        Where 1 = 1
        And TYPE = 'FAQ'
        And ID = #{id}
    </update>

    <!--
   - FAQ delete
   -->
    <delete id="deleteFaq">
        Delete
        From
            POSTS
        Where 1 = 1
        And TYPE = 'FAQ'
        And ID = #{id}
    </delete>

    <!--
     - FAQ 카테고리 목록 Select
     -->
    <select id="selectFaqCategoryList" resultType="kr.co.winnticket.community.faq.dto.FaqCategoryListGetResDto">
        Select
            a.ID,  -- 아이디
            a.NAME,  -- 이름
            a.DISPLAY_ORDER  -- 정렬순서
        FROM
             FAQ_CATEGORY_ITEM a
        Where 1 = 1
    </select>

    <!--
    - FAQ 카테고리 등록
    -->
    <insert id="insertFaqCategory" parameterType="kr.co.winnticket.community.faq.dto.FaqCategoryPostReqDto">
        <![CDATA[
        Insert Into FAQ_CATEGORY_ITEM
        (
            NAME,
            DISPLAY_ORDER
        )
        Values
        (
            #{name},
            (SELECT MAX(display_order) + 1 FROM FAQ_CATEGORY_ITEM)
        )
        ]]>
    </insert>

    <!--
    - FAQ 카테고리 수정
    -->
    <update id="updateFaqCategory">
        Update FAQ_CATEGORY_ITEM
        <set>
            <if test="name != null and name != ''">
                NAME = #{name},
            </if>
            UPDATED_AT = CURRENT_TIMESTAMP
        </set>
        Where 1 = 1
        And ID = #{id}
    </update>

    <!--
    - FAQ 카테고리 삭제
    -->
    <delete id="deleteFaqCategory">
        Delete
        From
            FAQ_CATEGORY_ITEM
        Where 1 = 1
        And ID = #{id}
    </delete>

    <!--
    - FAQ 카테고리 재정렬
    -->
    <update id="reorderDisplayOrder">
        With reordered As (
            Select 
                id,
                Row_Number() Over (Order By DISPLAY_ORDER) NEW_ORDER
            From
                FAQ_CATEGORY_ITEM
        )
        Update FAQ_CATEGORY_ITEM a
        Set 
            DISPLAY_ORDER = x.NEW_ORDER
        From
            reordered x
        Where 1 = 1
        And a.id = x.id
    </update>
</mapper>
