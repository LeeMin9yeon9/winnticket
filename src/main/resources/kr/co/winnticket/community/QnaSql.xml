<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.winnticket.community.qna.mapper.QnaMapper">
    <!--
    - QNA 상태별 카운트 Select
    -->
    <select id="selectQnaCnt" resultType="kr.co.winnticket.community.qna.dto.QnaCntGetResDto">
        <![CDATA[
        Select
            Count(*) ALL_CNT,  -- 전체글 수
            Sum(Case
                    When a.IS_BLOCKED = 'false' And a.STATUS = 'PENDING' Then 1
                    Else 0
                End) PENDING_CNT,  -- 답변대기글 수
            Sum(Case
                    When a.IS_BLOCKED = 'false' And a.STATUS = 'ANSWERED' Then 1
                    Else 0
                End) ANSWERED_CNT,  -- 답변완료글 수
            Sum(Case When IS_BLOCKED = 'true' Then 1 Else 0 End) BLOCKED_CNT  -- 차단글 수
        From
            POSTS a
        Where 1 = 1
        And a.TYPE = 'QNA'
        ]]>
    </select>

    <!--
    - QNA 목록 Select
    -->
    <select id="selectQnaList" resultType="kr.co.winnticket.community.qna.dto.QnaListGetResDto">
        Select
            a.ID,  -- 아이디
            a.TYPE,  -- 타입
            a.STATUS,  -- 상태
            a.TITLE,  -- 제목
            a.AUTHOR_NAME,  -- 작성자
            a.CREATED_AT,  -- 작성일자
            a.VIEWS,  -- 조회수
            a.IS_BLOCKED  -- 차단여부
        FROM
            POSTS a
        Where 1 = 1
        And a.TYPE = 'QNA'
        <if test="title != null and title != ''">
            <![CDATA[
            And Upper(a.TITLE) Like '%' || Upper(#{title}) || '%'
        ]]>
        </if>

        <if test="begDate != null">
            <![CDATA[
            AND Date(a.created_at) >= #{begDate}
        ]]>
        </if>

        <if test="endDate != null">
        <![CDATA[
            AND Date(a.created_at) <= #{endDate}
        ]]>
        </if>
        <choose>
            <when test="status == 'BLOCKED'">
                And a.IS_BLOCKED = true
            </when>
            <when test="status == 'PENDING'">
                And a.STATUS = 'PENDING'
                And a.IS_BLOCKED = false
            </when>
            <when test="status == 'ANSWERED'">
                And a.STATUS = 'ANSWERED'
                And a.IS_BLOCKED = false
            </when>
            <otherwise>
                <!-- 전체조회 -->
            </otherwise>
        </choose>
        Order By
            a.CREATED_AT Desc
    </select>

    <!--
    - QNA 상세 Select
    -->
    <select id="selectQnaDetail" resultType="kr.co.winnticket.community.qna.dto.QnaDetailGetResDto">
        Select
            a.ID,  -- 아이디
            a.STATUS,  -- 상태
            a.TITLE,  -- 제목
            a.CONTENT,  -- 내용
            a.AUTHOR_NAME,  -- 작성자
            a.CREATED_AT,  -- 작성일자
            a.ANSWER,  -- 답변
            a.ANSWERED_AT,  -- 답변일시
            a.IS_BLOCKED,  -- 차단여부
            a.BLOCKED_REASON,  --차단사유
            a.BLOCKED_AT  -- 차단일시
        FROM
        POSTS a
        Where 1 = 1
        And a.TYPE = 'QNA'
        And a.ID = #{id}
    </select>

    <!--
    - Qna 답변 등록
    -->
    <update id="updateQnaAnswer">
        Update POSTS
        <set>
            <if test="answer != null and answer != ''">
                ANSWER = #{answer},
            </if>
            <if test="answeredBy != null and answeredBy != ''">
                ANSWERED_BY = #{answeredBy},
            </if>
            ANSWERED_AT = CURRENT_TIMESTAMP,
            UPDATED_AT = CURRENT_TIMESTAMP,
            STATUS = 'ANSWERED'
        </set>
        Where 1 = 1
        And TYPE = 'QNA'
        And ID = #{id}
    </update>

    <!--
    - Qna 차단
    -->
    <update id="updateQnaBlock">
        Update POSTS
        <set>
            <if test="blockedReason != null and blockedReason != ''">
                BLOCKED_REASON = #{blockedReason},
            </if>
            <if test="blockedBy != null and blockedBy != ''">
                BLOCKED_BY = #{blockedBy},
            </if>
            BLOCKED_AT = CURRENT_TIMESTAMP,
            UPDATED_AT = CURRENT_TIMESTAMP,
            IS_BLOCKED = true
        </set>
        Where 1 = 1
        And TYPE = 'QNA'
        And ID = #{id}
    </update>

    <!--
    - Qna 차단 해제
    -->
    <update id="updateQnaUnblock">
        Update POSTS
        <set>
            BLOCKED_REASON = Null,
            BLOCKED_BY = Null,
            BLOCKED_AT = Null,
            UPDATED_AT = CURRENT_TIMESTAMP,
            IS_BLOCKED = false
        </set>
        Where 1 = 1
        And TYPE = 'QNA'
        And ID = #{id}
    </update>

    <!--
    - Qna 삭제
    -->
    <delete id="deleteQna">
        Delete
        From
            POSTS
        Where 1 = 1
        And TYPE = 'QNA'
        And ID = #{id}
    </delete>
</mapper>