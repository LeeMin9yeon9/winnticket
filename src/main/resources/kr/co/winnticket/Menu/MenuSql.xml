<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.winnticket.menu.menu.mapper.MenuCategoryMapper">

    <!-- 전체 메뉴 조회 -->
    <select id="menuAllList" resultType="kr.co.winnticket.menu.menu.entity.MenuCategory">
        SELECT *
        FROM menu_categories
        ORDER BY level, display_order
    </select>

    <!-- 메뉴명 중복 체크 -->
    <select id="countByMenuName" resultType="int">
        SELECT COUNT(*) FROM menu_categories WHERE name = #{name}
    </select>

    <!-- max display_order -->
    <select id="menuGetMaxOrder" resultType="int">
        SELECT COALESCE(MAX(display_order), 0)
        FROM menu_categories
    </select>

    <!-- 메뉴 생성 -->
    <insert id="menuInsert">
        INSERT INTO menu_categories(
            id, name, code, level, parent_id,
            display_order, visible, route_path
        ) VALUES (
                     #{id, jdbcType=OTHER},
                     #{name},
                     #{code},
                     #{level},
                     #{parentId, jdbcType=OTHER},
                     #{displayOrder},
                     #{visible},
                     #{routePath}
                 )
    </insert>

    <!-- 메뉴 조회 by ID -->
    <select id="menuFindById" resultType="kr.co.winnticket.menu.menu.entity.MenuCategory">
        SELECT *
        FROM menu_categories
        WHERE id = #{id, jdbcType=OTHER}
    </select>

    <!-- 메뉴 수정 -->
    <update id="menuUpdate">
        UPDATE menu_categories
        SET name = #{name},
            code = #{code},
            level = #{level},
            parent_id = #{parentId, jdbcType=OTHER},
            display_order = #{displayOrder},
            visible = #{visible},
            route_path = #{routePath}
        WHERE id = #{id, jdbcType=OTHER}
    </update>

    <!-- 삭제 -->
    <delete id="menuDelete">
        DELETE FROM menu_categories
        WHERE id = #{id, jdbcType=OTHER}
    </delete>

    <!-- 검색 -->
    <select id="menuSearch"
            parameterType="kr.co.winnticket.menu.menu.dto.MenuSearchDto"
            resultType="kr.co.winnticket.menu.menu.entity.MenuCategory">

        SELECT *
        FROM menu_categories
        <where>
            <if test="name != null and name != ''">
                AND name ILIKE CONCAT('%', #{name}, '%')
            </if>
            <if test="code != null and code != ''">
                AND code ILIKE CONCAT('%', #{code}, '%')
            </if>
        </where>

        ORDER BY level, display_order
    </select>

    <!-- 순서 변경 -->
    <update id="menuUpdateOrder">
        UPDATE menu_categories
        SET display_order = #{order}
        WHERE id = #{id, jdbcType=OTHER}
    </update>

    <!-- 활성/비활성 -->
    <update id="menuUpdateVisible">
        UPDATE menu_categories
        SET visible = #{visible}
        WHERE id = #{id, jdbcType=OTHER}
    </update>

    <!-- 형제 메뉴 중 특정 순서 메뉴 찾기 -->
    <select id="findByTreeMenu" resultType="kr.co.winnticket.menu.menu.entity.MenuCategory">
        SELECT *
        FROM menu_categories
        WHERE parent_id = #{parentId, jdbcType=OTHER}
          AND level = #{level}
          AND display_order = #{displayOrder}
            LIMIT 1
    </select>

    <!-- Swap 위한 업데이트 -->
    <update id="updateDisplayOrder">
        UPDATE menu_categories
        SET display_order = #{displayOrder}
        WHERE id = #{id, jdbcType=OTHER}
    </update>

</mapper>
