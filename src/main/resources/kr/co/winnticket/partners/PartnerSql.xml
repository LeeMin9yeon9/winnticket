<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.winnticket.partners.partnerinfo.mapper.PartnerMapper">

    <!-- 파트너 목록 / 검색 -->
    <select id="selectPartnerList"
            resultType="kr.co.winnticket.partners.partnerinfo.dto.PartnerListGetResDto">

        SELECT
        ID,
        CODE,
        NAME,
        STATUS,
        CREATED_AT,
        UPDATED_AT
        FROM PARTNERS
        WHERE 1=1

        <!-- 키워드 검색 -->
        <if test="keyword != null and keyword != ''">
            AND (
            NAME ILIKE '%' || #{keyword} || '%'
            OR CODE ILIKE '%' || #{keyword} || '%'
            )
        </if>

        <!-- 상태 필터 -->
        <choose>
            <!-- 상태를 명시적으로 선택한 경우 -->
            <when test="AllStatus != null">
                AND STATUS = #{AllStatus}
            </when>

            <!-- 기본값: ACTIVE, INACTIVE만 -->
            <otherwise>
                AND STATUS IN ('ACTIVE', 'INACTIVE')
            </otherwise>
        </choose>

        <!-- 타입 필터 -->
        <if test="AllType != null">
            AND TYPE = #{AllType}
        </if>

        <!-- 정렬 우선순위 -->
        ORDER BY
        CASE STATUS
        WHEN 'ACTIVE' THEN 1
        WHEN 'INACTIVE' THEN 2
        WHEN 'DELETED' THEN 3
        END,
        CREATED_AT DESC

    </select>


    <!-- 파트너 기본 정보 -->
    <select id="selectPartnerInfo"
            parameterType="java.util.UUID"
            resultType="kr.co.winnticket.partners.partnerinfo.dto.PartnerInfoGetResDto">

        SELECT
            p.ID,
            p.CODE,
            p.NAME,
            p.TYPE,
            p.COMMISSION_RATE AS commissionRate,
            p.BUSINESS_NUMBER AS businessNumber,
            p.ADDRESS,
            p.MANAGER_NAME AS managerName,
            p.MANAGER_EMAIL AS managerEmail,
            p.MANAGER_PHONE AS managerPhone,
            p.CONTRACT_START_DATE AS contractStartDate,
            p.CONTRACT_END_DATE AS contractEndDate,
            P.LOGO_URL AS logoUrl

        FROM PARTNERS p
        WHERE p.ID = #{id}
    </select>


    <!-- 파트너 등록 -->
    <insert id="insertPartner" parameterType="kr.co.winnticket.partners.partnerinfo.dto.PartnerPostReqDto">
        INSERT INTO PARTNERS (
            ID,
            CODE,
            NAME,
            TYPE,
            STATUS,
            BUSINESS_NUMBER,
            ADDRESS,
            MANAGER_NAME,
            MANAGER_EMAIL,
            MANAGER_PHONE,
            CONTRACT_START_DATE,
            CONTRACT_END_DATE,
            COMMISSION_RATE,
            LOGO_URL,
            DESCRIPTION,
            COUPON_CODE,
            CREATED_AT,
            UPDATED_AT
        )
        VALUES(
                  gen_random_uuid(),
                  #{code},
                  #{name},
                  #{type},
                  #{status},
                  #{businessNumber},
                  #{address},
                  #{managerName},
                  #{managerEmail},
                  #{managerPhone},
                  #{contractStartDate},
                  #{contractEndDate},
                  #{commissionRate},
                  #{logoUrl},
                  #{description},
                  #{couponCode},
                  NOW(),
                  NOW()
              )
    </insert>


    <!-- 파트너 수정 -->
    <update id="updatePartner">
        UPDATE PARTNERS
        <set>
            <if test="model.code != null">CODE = #{model.code},</if>
            <if test="model.name != null">NAME = #{model.name},</if>
            <if test="model.type != null">TYPE = #{model.type},</if>
            <if test="model.status != null">STATUS = #{model.status},</if>
            <if test="model.businessNumber != null">BUSINESS_NUMBER = #{model.businessNumber},</if>
            <if test="model.address != null">ADDRESS = #{model.address},</if>
            <if test="model.managerName != null">MANAGER_NAME = #{model.managerName},</if>
            <if test="model.managerEmail != null">MANAGER_EMAIL = #{model.managerEmail},</if>
            <if test="model.managerPhone != null">MANAGER_PHONE = #{model.managerPhone},</if>
            <if test="model.contractStartDate != null">CONTRACT_START_DATE = #{model.contractStartDate},</if>
            <if test="model.contractEndDate != null">CONTRACT_END_DATE = #{model.contractEndDate},</if>
            <if test="model.commissionRate != null">COMMISSION_RATE = #{model.commissionRate},</if>
            <if test="model.logoUrl != null">LOGO_URL = #{model.logoUrl},</if>
            <if test="model.description != null">DESCRIPTION = #{model.description},</if>
            <if test="model.couponCode != null">COUPON_CODE = #{model.couponCode},</if>
            UPDATED_AT = NOW()
        </set>
        WHERE ID = #{id}
    </update>


    <!-- 파트너 삭제 -->
    <update id="deletePartner" parameterType="java.util.UUID">
        UPDATE PARTNERS
        SET STATUS = 'DELETED',
            UPDATED_AT = NOW()
        WHERE ID = #{id}
    </update>


    <!-- 연관 상품 비활성화 -->
    <update id="disableProductsByPartnerId" parameterType="java.util.UUID">
        UPDATE PRODUCTS
        SET
            VISIBLE = FALSE,
            SALES_STATUS = 'STOPPED',
            UPDATED_AT = NOW()
        WHERE PARTNER_ID = #{partnerId}
    </update>

    <!-- 파트너 복구 -->
    <update id="restorePartner" parameterType="java.util.UUID">
        UPDATE PARTNERS
        SET STATUS = 'ACTIVE',
            UPDATED_AT = NOW()
        WHERE ID = #{id}
    </update>

    <!-- 연관 상품 복구 -->
    <update id="restoreProductsByPartnerId" parameterType="java.util.UUID">
        UPDATE PRODUCTS
        SET
            VISIBLE = TRUE,
            SALES_STATUS = 'READY',
            UPDATED_AT = NOW()
        WHERE PARTNER_ID = #{partnerId}
    </update>


    <update id="updatePartnerStatus">
        UPDATE partners
        SET status = #{status}, updated_at = NOW()
        WHERE id = #{id}
    </update>

    <!--파트너 코드 중복 체크-->
    <select id="existsCode" resultType="int">
        SELECT COUNT(*)
        FROM partners
        WHERE CODE = #{code}
        AND VISIBLE = TRUE
        <if test="id != null">
            AND ID != #{id}   <!-- 수정일 때만 본인 제외 -->
        </if>
    </select>

</mapper>