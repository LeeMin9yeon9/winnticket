<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.winnticket.partners.fieldmanager.mapper.FieldManagerMapper">

    <resultMap id="FieldManagerResMap"
               type="kr.co.winnticket.partners.fieldmanager.dto.FieldManagerResDto">

        <id column="id" property="id"/>

        <result column="user_name" property="userName"/>
        <result column="password" property="password"/>
        <result column="name" property="name"/>
        <result column="email" property="email"/>
        <result column="phone" property="phone"/>

        <result column="partner_id" property="partnerId"/>
        <result column="partner_name" property="partnerName"/>

        <result column="active" property="active"/>

        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>

    </resultMap>

    <!-- 파트너별 현장관리자 목록 -->
    <select id="getListByPartner"
            resultType="kr.co.winnticket.partners.fieldmanager.dto.FieldManagerListGetResDto">
        SELECT
            fm.id,
            fm.name,
            fm.email,
            fm.phone,
            fm.active,
            fm.created_at AS createdAt
        FROM field_managers fm
        WHERE fm.partner_id = #{partnerId}::uuid
          AND fm.role_id = 'ROLE002'
        ORDER BY fm.created_at DESC
    </select>

    <!-- 상세 조회 -->
    <select id="getDetail" resultMap="FieldManagerResMap">
        SELECT
            fm.id,
            fm.account_id AS user_name,
            fm.password,
            fm.name,
            fm.email,
            fm.phone,
            fm.active,
            fm.partner_id,
            p.name AS partner_name,
            fm.created_at,
            fm.updated_at
        FROM field_managers fm
                 LEFT JOIN partners p ON fm.partner_id = p.id
        WHERE fm.id = #{id}::uuid
    </select>

    <!-- 생성 -->
    <insert id="insert">
        INSERT INTO field_managers (
        id,
        account_id,
        password,
        role_id,
        name,
        email,
        phone,
        partner_id,
        active,
        created_at,
        updated_at
        ) VALUES (
        #{id},
        #{model.userName},
        #{model.password},
        'ROLE002',                <!-- 현장관리자는 고정 -->
        #{model.name},
        #{model.email},
        #{model.phone},
        #{model.partnerId}::uuid,
        COALESCE(#{model.active}, TRUE),
        NOW(),
        NOW()
        )
    </insert>

    <!--  수정 -->
    <update id="update">
        UPDATE field_managers
        <set>
            <if test="model.userName != null"> account_id = #{model.userName}, </if>
            <if test="model.password != null"> password   = #{model.password}, </if>
            <if test="model.name != null">     name       = #{model.name}, </if>
            <if test="model.email != null">    email      = #{model.email}, </if>
            <if test="model.phone != null">    phone      = #{model.phone}, </if>
            <if test="model.active != null">   active     = #{model.active}, </if>
            updated_at = NOW(),
        </set>
        WHERE id = #{id}::uuid
        AND role_id = 'ROLE002'   <!-- ROLE002만 수정 -->
    </update>

    <!--  비밀번호 변경-->
    <select id="getPassword" resultType="string">
        SELECT password FROM field_managers WHERE id = #{id}::uuid
    </select>

    <update id="updatePassword">
        UPDATE field_managers
        SET password = #{newPassword},
            password_updated_at = NOW(),
            updated_at = NOW()
        WHERE id = #{id}::uuid
    </update>

    <!--관리자 비밀번호 초기화-->
    <update id="resetPassword">
        UPDATE field_managers
        SET password = #{newPassword},
            password_updated_at = NOW(),
            updated_at = NOW()
        WHERE id = #{id}::uuid
    </update>

    <delete id="delete">
        DELETE FROM field_managers
        WHERE id = #{id}::uuid
          AND role_id = 'ROLE002'
    </delete>



</mapper>
