<?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
                "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.winnticket.channels.channel.mapper.ChannelMapper">

    <select id="selectPartnerList" resultType="kr.co.winnticket.channels.channel.dto.ChannelListGetResDto">
        SELECT
        id,
        code,
        logo_url AS logoUrl,
        name,
        company_name AS companyName,
        visible,
        domain
        FROM channels
        WHERE 1 = 1

        <if test="code != null and code != ''">
            AND code ILIKE CONCAT('%', #{code}, '%')
        </if>

        <if test="name != null and name != ''">
            AND name ILIKE CONCAT('%', #{name}, '%')
        </if>

        <if test="companyName != null and companyName != ''">
            AND company_name ILIKE CONCAT('%', #{companyName}, '%')
        </if>

        ORDER BY created_at DESC
    </select>

    <insert id="createChannel" parameterType="kr.co.winnticket.channels.channel.dto.ChannelCreateReqDto">
        INSERT INTO channels(
            id,
            code,
            name,
            company_name,
            commission_rate,
            logo_url,
            favicon_url,
            email,
            phone,
            domain,
            description,
            use_card,
            visible,
            created_at,
            updated_at
        )
        VALUES (
            gen_random_uuid(),
            #{code},
            #{name},
            #{companyName},
            #{commissionRate},
            #{logoUrl},
            #{faviconUrl},
            #{email},
            #{phone},
            #{domain},
            #{description},
            COALESCE(#{useCard}, FALSE),
            COALESCE(#{visible},TRUE),
            NOW(),
            NOW()
               )
    </insert>

    <select id="selectChannel" resultType="kr.co.winnticket.channels.channel.dto.ChannelInfoResGetDto">

        SELECT
            id,
            code,
            name,
            company_name AS companyName,
            commission_rate AS commissionRate,
            logo_url AS logoUrl,
            favicon_url AS faviconUrl,
            email,
            phone,
            domain,
            description,
            visible,
            use_card AS useCard,
            created_at AS createdAt,
            updated_at AS updatedAt
        FROM channels
        WHERE id = #{id}

    </select>

    <!--채널 기본정보 수정-->
    <update id="updateChannel">
        UPDATE CHANNELS
        <set>
            <if test="model.code != null">CODE = #{model.code},</if>
            <if test="model.name != null">NAME = #{model.name},</if>
            <if test="model.companyName != null">COMPANY_NAME = #{model.companyName},</if>
            <if test="model.visible != null">VISIBLE = #{model.visible},</if>
            <if test="model.commissionRate != null">COMMISSION_RATE = #{model.commissionRate},</if>
            <if test="model.description != null">DESCRIPTION = #{model.description},</if>
            <if test="model.logoUrl != null">LOGO_URL = #{model.logoUrl},</if>
            <if test="model.faviconUrl != null">FAVICON_URL = #{model.faviconUrl},</if>
            <if test="model.email != null">EMAIL = #{model.email},</if>
            <if test="model.phone != null">PHONE = #{model.phone},</if>
            <if test="model.domain != null">DOMAIN = #{model.domain},</if>
            <if test="model.useCard != null">USE_CARD = #{model.useCard},</if>
            UPDATED_AT = NOW()
        </set>
        WHERE ID = #{id}
    </update>

    <!--채널 삭제-->
    <delete id="deleteChannel" parameterType="java.util.UUID">
        DELETE FROM channels
        WHERE ID = #{id}
    </delete>

    <!--채널 코드 중복 체크-->
    <select id="existsCode" resultType="int">
        SELECT COUNT(*)
        FROM channels
        WHERE CODE = #{code}
        AND VISIBLE = TRUE
        <if test="id != null">
            AND ID != #{id}   <!-- 수정일 때만 본인 제외 -->
        </if>
    </select>

    <!-- 활성/비활성 변경 -->
    <update id="visibleChannel">
        UPDATE channels
        SET visible = #{visible},
            updated_at = CURRENT_TIMESTAMP
        WHERE id = #{id}::uuid;
    </update>

    <!-- 채널코드로 아이디찾기 -->
    <select id="selectChannelIdByCode" resultType="java.util.UUID">
        SELECT id
        FROM channels
        WHERE code = #{channelCode}
          AND VISIBLE = true
    </select>

    <!--채널코드로 기본정보-->
    <select id="selectChannelByCode"
            parameterType="string"
            resultType="kr.co.winnticket.channels.channel.dto.ChannelInfoResGetDto">

        SELECT
            id,
            code,
            name,
            company_name AS companyName,
            commission_rate AS commissionRate,
            logo_url AS logoUrl,
            favicon_url AS faviconUrl,
            email,
            phone,
            domain,
            description,
            visible,
            created_at AS createdAt,
            updated_at AS updatedAt
        FROM channels
        WHERE code = #{code}

    </select>

    <!--카드결제 사용 여부-->
    <select id="selectUseCardById" resultType="boolean">
        SELECT use_card
        FROM channels
        WHERE id = #{id}
    </select>
</mapper>