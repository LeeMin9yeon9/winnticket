<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.winnticket.order.shop.mapper.OrderShopMapper">
    <!--
   - 주문 상세 Select
   -->
    <select id="selectOrderShop" resultType="kr.co.winnticket.order.shop.dto.OrderShopGetResDto">
        Select
            a.id, -- 주문_ID
            a.order_number, -- 주문번호
            a.ordered_at, -- 주문일시
            (
                Select
                    x.name
                From
                    channels x
                Where 1 = 1
                  And x.id = a.channel_id
            ) channel_name, -- 채널명
            a.status, -- 주문상태
            a.customer_name, -- 주문자
            a.customer_phone, -- 주문자 연락처
            a.customer_email,  -- 주문자이메일
            a.payment_status, -- 결제상태
            a.final_price, -- 결제금액
            a.payment_method, -- 결제수단
            a.paid_at,  -- 결제일시
            a.total_price, -- 상품총금액
            a.memo -- 요청사항
        FROM
            orders a
        Where 1 = 1
        And a.ORDER_NUMBER = #{orderNumber}
    </select>

    <!--
    - 주문 상품 목록 Select
    -->
    <select id="selectOrderProductList" resultType="kr.co.winnticket.order.admin.dto.OrderProductListGetResDto">
        Select
            a.id, -- 주문상품_ID
            a.product_id, -- 상품ID
            a.product_name, -- 상품명
            (
                Select
                    x.name
                From menu_categories x
                         Join
                     Products y
                     On x.id = y.category_id
                where 1 = 1
                  And y.id = a.product_id
            ) category_name, -- 카테고리명
            d.name partner_name,  -- 파트너명
            STRING_AGG(e.option_value, ' ' ORDER BY e.id) option_name,  -- 옵션명
            a.quantity,
            a.unit_price,
            a.total_price
        FROM
            order_items a
                JOIN orders b
                     ON b.id = a.order_id
                JOIN products c
                     ON c.id = a.product_id
                JOIN partners d
                     ON d.id = c.partner_id
                LEFT JOIN order_item_options e
                          ON e.order_item_id = a.id
        Where 1 = 1
          And a.order_id = #{id}
        GROUP BY
            a.id,
            a.product_name,
            d.name,
            a.quantity,
            a.unit_price,
            a.total_price
    </select>

    <!--
    - 주문테이블 insert
    -->
    <select id="insertOrder" resultType="map">
        Insert Into ORDERS
        (
            ORDER_NUMBER,
            CHANNEL_ID,
            CUSTOMER_NAME,
            CUSTOMER_PHONE,
            CUSTOMER_EMAIL,
            TOTAL_PRICE,
            DISCOUNT_PRICE,
            FINAL_PRICE,
            STATUS,
            PAYMENT_METHOD,
            PAYMENT_STATUS
        )
        Values
        (
            'W'|| TO_CHAR(NOW(), 'YYYYMMDDHH24MISS') || NEXTVAL('seq_order_number'),
            #{channelId},
            #{customerName},
            #{customerPhone},
            #{customerEmail},
            #{totalPrice},
            #{discountPrice},
            0,
            'PENDING_PAYMENT',
            #{paymentMethod}::payment_method,
            'READY'
        )
        RETURNING id, order_number
    </select>

    <!--
    - 주문상품별 insert
    -->
    <select id="insertOrderItem" resultType="java.util.UUID">
        Insert Into ORDER_ITEMS
        (
            ORDER_ID,
            PRODUCT_ID,
            PRODUCT_NAME,
            QUANTITY,
            UNIT_PRICE,
            TOTAL_PRICE
        )
        Values
        (
            #{orderId},
            #{productId},
            #{productName},
            #{quantity},
            #{unitPrice},
            #{totalPrice}
        )
        RETURNING id
    </select>

    <!--
    - 주문상품별 옵션 insert
    -->
    <insert id="insertOrderItemOption">
        Insert Into ORDER_ITEM_OPTIONS
        (
            ORDER_ITEM_ID,
            OPTION_NAME,
            OPTION_VALUE,
            ADDITIONAL_PRICE
        )
        Values
        (
            #{orderItemId},
            #{optionName},
            #{optionValueName},
            #{additionalPrice}
        )
    </insert>

    <!--
    - 최종결제금액 update
    -->
    <update id="updateOrderPrice">
        update ORDERS
        Set
            FINAL_PRICE = #{finalPrice}
        Where 1 = 1
        And id = #{orderId}
    </update>

    <!--Payletter 결제 요청 시 PG정보 저장-->
    <update id="updatePayletterRequest">
        UPDATE orders
        SET
            pg_provider = #{pgProvider},
            pg_tid = #{pgTid},
            pg_online_url = #{pgOnlineUrl},
            pg_mobile_url = #{pgMobileUrl},
            payment_status = 'REQUESTED',
            updated_at = NOW()
        WHERE id = #{orderId}::uuid
    </update>

    <!--payletter 결제 요청 시 상품이름+개수-->
    <select id="selectPayletterProductSummary" resultType="map">
        SELECT
            (SELECT product_name
             FROM order_items
             WHERE order_id = #{orderId}::uuid
        ORDER BY created_at ASC
            LIMIT 1) AS first_product_name,
        (SELECT COUNT(*)
        FROM order_items
        WHERE order_id = #{orderId}::uuid) AS item_count
    </select>

    <!--콜백 성공 처리-->
    <update id="updatePayletterCallbackSuccessIfNotPaid">
        UPDATE orders
        SET
        payment_status = 'PAID'::payment_status,
        paid_at = CURRENT_TIMESTAMP,
        pg_provider = 'PAYLETTER',
        pg_tid = #{tid},
        pg_approval_no = #{cid},
        pg_callback_payload = CAST(#{payloadJson} AS jsonb),
        pg_callback_received_at = CURRENT_TIMESTAMP,
        updated_at = CURRENT_TIMESTAMP
        WHERE id = #{orderId}
        AND payment_status <> 'PAID'::payment_status
    </update>

    <!--콜백 실패 처리-->
    <update id="updatePayletterCallbackFailed">
        UPDATE orders
        SET
            payment_status = 'FAILED'::payment_status,
            payment_fail_reason = #{failReason},

            pg_callback_payload = CAST(#{payloadJson} AS jsonb),
            pg_callback_received_at = CURRENT_TIMESTAMP,

            updated_at = CURRENT_TIMESTAMP
        WHERE id = #{orderId}
    </update>

    <!--주문 결제정보 조회 검증용임-->
    <select id="selectOrderPaymentInfo" resultType="map">
        SELECT
            id,
            order_number,
            final_price,
            payment_status,
            pg_provider,
            pg_tid,
            pg_approval_no
        FROM orders
        WHERE id = #{orderId}
    </select>
</mapper>